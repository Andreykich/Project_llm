from .base_agent import BaseAgent
from config import config
import json
import logging

logger = logging.getLogger(__name__

)

class DataAnalyzerAgent(BaseAgent):
    """
    –£–ª—É—á—à–µ–Ω–Ω—ã–π –∞–≥–µ–Ω—Ç –∞–Ω–∞–ª–∏–∑–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π (Reasoning)
    
    –§–∏–ª–æ—Å–æ—Ñ–∏—è —Ä–∞–±–æ—Ç—ã:
    - Chain-of-Thought: –¥–µ–ª–∏–º —Å–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏ –Ω–∞ —à–∞–≥–∏
    - Context Engineering: –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–∞–∫—Å–∏–º—É–º –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    - Structured Output: –≤—Å–µ–≥–¥–∞ JSON —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
    """
    
    def __init__(self, db=None):
        super().__init__(
            name="DataAnalyzer",
            system_prompt=config.PROMPTS["data_analyzer"]
        )
        self.db = db
        self.analysis_steps = []
    
    def generate_advice(self, user_ dict) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –±–∏–∑–Ω–µ—Å-–∏–¥–µ–∏.
        
        –°—Ç—Ä–æ–∏—Ç Chain-of-Thought –ø—Ä–æ—Ü–µ—Å—Å –º—ã—à–ª–µ–Ω–∏—è –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.
        
        Args:
            user_ –î–∞–Ω–Ω—ã–µ –æ –±–∏–∑–Ω–µ—Å-–∏–¥–µ–µ (industry, idea, city, budget, –∏ —Ç.–¥.)
            
        Returns:
            –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        """
        
        # –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –º—ã—à–ª–µ–Ω–∏—è
        self.add_reasoning_step("–ü–æ–Ω–∞—á–∞–ª—É: –∞–Ω–∞–ª–∏–∑ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö")
        logger.info(f"[DataAnalyzer] –ù–∞—á–∏–Ω–∞—é –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö: industry={user_data.get('industry')}, idea={user_data.get('idea')}")
        
        # –°—Ç—Ä–æ–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
        analysis_prompt = self._build_analysis_prompt(user_data)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ LLM —Å Function Calling
        logger.info("[DataAnalyzer] –ù–∞—á–∏–Ω–∞—é –∞–Ω–∞–ª–∏–∑ –≤ LLM...")
        result = self.call_llm_with_tools(analysis_prompt, temperature=0.5)
        
        advice = result.get("response", "")
        reasoning = result.get("reasoning", "")
        
        if reasoning:
            self.add_reasoning_step(f"–û–±—ä—è—Å–Ω–µ–Ω–∏–µ LLM: {reasoning}")
        
        # –ö—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥
        logger.info("[DataAnalyzer] –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞")
        return self._format_advice(advice, user_data)
    
    def _build_analysis_prompt(self, user_ dict) -> str:
        """
        –°—Ç—Ä–æ–∏—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å–æ –≤—Å–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º.
        
        –ù–∞ –æ—Å–Ω–æ–≤–µ –õ–µ–∫—Ü–∏–∏ 7 - Context Engineering:
        - –ì–ª–∞–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        - –õ–æ–≥–∏–∫–∞ –ê–ù–ê–õ–ò–ó -> –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò
        - –ñ—ë—Å—Ç–∫–æ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã
        """
        
        template = f"""
## –ö–û–ù–ö–†–ï–¢–ù–´–ï –î–ê–ù–ù–´–ï –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê

**–ò–Ω–¥—É—Å—Ç—Ä–∏—è**: {user_data.get('industry', 'N/A')}
**–ë–∏–∑–Ω–µ—Å-–∏–¥–µ—è**: {user_data.get('idea', 'N/A')}
**–ì–µ–æ–≥—Ä–∞—Ñ–∏—è**: {user_data.get('city', 'N/A')}
**–ù–∞—á–∞–ª—å–Ω—ã–π –±—é–¥–∂–µ—Ç**: {user_data.get('budget', 'N/A')}
**–û–ø—ã—Ç –∞–≤—Ç–æ—Ä–∞**: {user_data.get('experience', 'N/A')}
**–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è**: {user_data.get('target_audience', 'N/A')}
**–û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è**: {user_data.get('special_requirements', 'N/A')}

## –ü–û–†–Ø–î–û–ö –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê (—Å—Ç—Ä–æ–≥–æ –ø–æ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏—é!):

### –ó–ê–ü–û–õ–ù–ò –ö–ê–ö –ú–ò–ù–ò–ú–£–ú –¢–†–ò –ü–£–ù–ö–¢–ê

1. **–¢–†–ï–ù–î –ò –†–´–ù–û–ö** (–ú–ò–ù 3 –ø—É–Ω–∫—Ç–∞):
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã –≤ {user_data.get('industry', '—ç—Ç–æ–π —Å—Ñ–µ—Ä–µ')} —Å–µ–π—á–∞—Å
   - –ö–∞–∫–∏–µ –≥–æ—Ä—è—á–∏–µ –Ω–∏—à–∏ –≤ —ç—Ç–æ–º —Å–µ–≥–º–µ–Ω—Ç–µ?
   - –ü—Ä–æ–≥–Ω–æ–∑—ã —Ä—ã–Ω–∫–∞ –Ω–∞ 2025 –≥–æ–¥

2. **–í–û–ó–ú–û–ñ–ù–û–°–¢–ò** (–ú–ò–ù 3 –ø—É–Ω–∫—Ç–∞):
   - –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏
   - –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –∏–¥–µ–∏
   - –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –ø–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤

3. **–†–ò–°–ö–ò** (–ú–ò–ù 3 –ø—É–Ω–∫—Ç–∞):
   - –ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è –∏ –µ—ë —Å–∏–ª–∞
   - –ë–∞—Ä—å–µ—Ä—ã –¥–ª—è –≤—Ö–æ–¥–∞
   - –ù–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Ä–∏—Å–∫–∏

4. **–ü–õ–ê–ù –ó–ê–ü–£–°–ö–ê** (–°–ø–µ—Ü–∏—Ñ–∏–∫–∞ –¥–ª—è {user_data.get('city', '–≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞')}):
   - –ú–µ—Å—è—Ü—ã 1-3: [–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏]
   - –ú–µ—Å—è—Ü—ã 4-6: [—ç–∫—Å–ø–∞–Ω—Å–∏—è]
   - –ì–æ–¥ 2: [–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è]

5. **–§–ò–ù–ê–ù–°–û–í–ê–Ø –°–¢–†–ê–¢–ï–ì–ò–Ø**:
   - –ê–ª–ª–æ–∫–∞—Ü–∏—è –±—é–¥–∂–µ—Ç–∞ (–∑–Ω–∞—è —á—Ç–æ {user_data.get('budget', '–±—é–¥–∂–µ—Ç –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω')})
   - –†–∞—Å—á—ë—Ç ROI
   - –û–∂–∏–¥–∞–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–æ—Ö–æ–¥–∞

6. **–ú–ê–†–ö–ï–¢–ò–ù–ì –ò –ü–†–û–î–í–ò–ñ–ï–ù–ò–ï**:
   - –õ—É—á—à–∏–µ –∫–∞–Ω–∞–ª—ã –¥–ª—è {user_data.get('target_audience', '—Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏')}
   - –ë—é–¥–∂–µ—Ç –Ω–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥
   - –¢–∞–∫—Ç–∏–∫–∏ –≤—ã—Ö–æ–¥–∞

7. **–ö–û–ù–ö–£–†–ï–ù–¢–´ –ò –ü–ê–†–¢–ù–Å–†–´**:
   - 2-3 –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞: [–Ω–∞–∑–≤–∞–Ω–∏–µ + —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã]
   - 2-3 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–∞: [–∫–∞–∫ –º–æ–≥—É—Ç –ø–æ–º–æ—á—å]

8. **–ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê**:
   - –û—Ü–µ–Ω–∏ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏–¥–µ–∏: –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è / –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–æ / –•–æ—Ä–æ—à–æ –∏ —Ç.–¥.
   - –û—Ü–µ–Ω–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —É—Å–ø–µ—Ö–∞ (–≥–æ–¥ 1): 10-90%
   - –ê–≤—Ç–æ—Ä—É ‚Äî —Å—Ç–æ–∏—Ç –Ω–∞—á–∏–Ω–∞—Ç—å? [–¥–∞/–Ω–µ—Ç] + –ö—Ä–∞—Ç–∫–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
"""
        return template
    
    def _format_advice(self, advice: str, user_ dict) -> str:
        """
        –û—Ñ–æ—Ä–º–ª—è–µ—Ç –∞–Ω–∞–ª–∏–∑ –≤ –∫—Ä–∞—Å–∏–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≤—ã–≤–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
        """
        formatted_output = f"""
üéØ **–ê–ù–ê–õ–ò–ó: {user_data.get('idea', 'Your Business Idea')}**

{advice}

---
**–ü—Ä–æ—Ü–µ—Å—Å –∞–Ω–∞–ª–∏–∑–∞ (–¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏)**
{self.get_reasoning_trace()}
        """
        return formatted_output
